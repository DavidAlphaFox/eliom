<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Wrapping  &amp;#182;</title><meta charset="utf8"/></head><body><h1> Eliom's Reference manual</h1><h2><a href="/eliom/6.2/manual/intro.html" class="ocsimore_phrasing_link">Introduction</a></h2><h2>Server-side programming</h2><h3>Services</h3><h4><a href="/eliom/6.2/manual/server-services.html" class="ocsimore_phrasing_link">The different types of services</a></h4><h4><a href="/eliom/6.2/manual/server-params.html" class="ocsimore_phrasing_link">Typing service parameters</a></h4><h4><a href="/eliom/6.2/manual/server-outputs.html" class="ocsimore_phrasing_link">Service handlers</a></h4><h4><a href="/eliom/6.2/manual/server-links.html" class="ocsimore_phrasing_link">Creating links and forms</a></h4><h3><a href="/eliom/6.2/manual/server-state.html" class="ocsimore_phrasing_link">Sessions and server side state</a></h3><h3><a href="/eliom/6.2/manual/server-security.html" class="ocsimore_phrasing_link">Security</a></h3><h2>Client-server programming</h2><h3><a href="/eliom/6.2/manual/clientserver-applications.html" class="ocsimore_phrasing_link">Eliom applications</a></h3><h3><a href="/eliom/6.2/manual/clientserver-html.html" class="ocsimore_phrasing_link">Generating HTML</a></h3><h3><a href="/eliom/6.2/manual/clientserver-communication.html" class="ocsimore_phrasing_link">Communication</a></h3><h3><a href="/eliom/6.2/manual/clientserver-services.html" class="ocsimore_phrasing_link">Client-side services</a></h3><h3><a href="/eliom/6.2/manual/clientserver-react.html" class="ocsimore_phrasing_link">Shared reactive programming</a></h3><h3><a href="/eliom/6.2/manual/clientserver-cache.html" class="ocsimore_phrasing_link">Caching data and off-line applications</a></h3><h3><a href="/eliom/6.2/manual/clientserver-wrapping.html" class="ocsimore_phrasing_link">Custom wrapping</a></h3><h2>Workflows</h2><h3><a href="/eliom/6.2/manual/workflow-distillery.html" class="ocsimore_phrasing_link">Distillery</a></h3><h3><a href="/eliom/6.2/manual/mobile-apps.html" class="ocsimore_phrasing_link">Mobile apps</a></h3><h3><a href="/eliom/6.2/manual/workflow-compilation.html" class="ocsimore_phrasing_link">Compilation</a></h3><h3><a href="/eliom/6.2/manual/workflow-configuration.html" class="ocsimore_phrasing_link">Configuration &amp; running</a></h3><h3><a href="/eliom/6.2/manual/scalability.html" class="ocsimore_phrasing_link">Scalability</a></h3><h2>Syntax</h2><h3><a href="/eliom/6.2/manual/ppx-syntax.html" class="ocsimore_phrasing_link">PPX-based syntax</a></h3><h3><a href="/eliom/6.2/manual/clientserver-language.html" class="ocsimore_phrasing_link">Camlp4-based syntax</a></h3><h3><a href="/eliom/6.2/manual/ppx-migration.html" class="ocsimore_phrasing_link">Migration to PPX</a></h3><h1>Server API</h1><h2><a href="/eliom/6.2/api/server/Eliom_lib.html" class="ocsimore_phrasing_link">Eliom_lib</a></h2><h2><a href="/eliom/6.2/api/server/Eliom_client.html" class="ocsimore_phrasing_link">Eliom_client</a></h2><h2><a href="/eliom/6.2/api/server/Eliom_client_value.html" class="ocsimore_phrasing_link">Eliom_client_value</a></h2><h2><a href="/eliom/6.2/api/server/Eliom_common.html" class="ocsimore_phrasing_link">Eliom_common</a></h2><h2><a href="/eliom/6.2/api/server/Eliom_config.html" class="ocsimore_phrasing_link">Eliom_config</a></h2><h2><a href="/eliom/6.2/api/server/Eliom_request_info.html" class="ocsimore_phrasing_link">Eliom_request_info</a></h2><h2><a href="/eliom/6.2/api/server/Eliom_reference.html" class="ocsimore_phrasing_link">Eliom_reference</a></h2><h2><a href="/eliom/6.2/api/server/Eliom_state.html" class="ocsimore_phrasing_link">Eliom_state</a></h2><h2>Content and form creation</h2><h3><a href="/eliom/6.2/api/server/Eliom_content.html" class="ocsimore_phrasing_link">Eliom_content</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_content.Html.html" class="ocsimore_phrasing_link">Eliom_content.Html</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_content.Svg.html" class="ocsimore_phrasing_link">Eliom_content.Svg</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_content.Xml.html" class="ocsimore_phrasing_link">Eliom_content.Xml</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_tools.html" class="ocsimore_phrasing_link">Eliom_tools</a></h3><h2>Service creation</h2><h3><a href="/eliom/6.2/api/server/Eliom_service.html" class="ocsimore_phrasing_link">Eliom_service</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_parameter.html" class="ocsimore_phrasing_link">Eliom_parameter</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_registration.html" class="ocsimore_phrasing_link">Eliom_registration</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_registration.Html.html" class="ocsimore_phrasing_link">Eliom_registration.Html</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_registration.Action.html" class="ocsimore_phrasing_link">Eliom_registration.Action</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_registration.Ocaml.html" class="ocsimore_phrasing_link">Eliom_registration.Ocaml</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_registration.App.html" class="ocsimore_phrasing_link">Eliom_registration.App</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_registration.File.html" class="ocsimore_phrasing_link">Eliom_registration.File</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_registration.Any.html" class="ocsimore_phrasing_link">Eliom_registration.Any</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_registration.Redirection.html" class="ocsimore_phrasing_link">Eliom_registration.Redirection</a></h3><h2>Client/server communication</h2><h3><a href="/eliom/6.2/api/server/Eliom_shared.html" class="ocsimore_phrasing_link">Eliom_shared</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_notif.html" class="ocsimore_phrasing_link">Eliom_notif</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_cscache.html" class="ocsimore_phrasing_link">Eliom_cscache</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_bus.html" class="ocsimore_phrasing_link">Eliom_bus</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_comet.html" class="ocsimore_phrasing_link">Eliom_comet</a></h3><h3><a href="/eliom/6.2/api/server/Eliom_react.html" class="ocsimore_phrasing_link">Eliom_react</a></h3><h2>Index</h2><h3> <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/index_types.html">Index of types</a></span></h3><h3> <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/index_exceptions.html">Index of exceptions</a></span></h3><h3> <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/index_values.html">Index of values</a></span></h3><h3> <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/index_modules.html">Index of modules</a></span></h3><h3> <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/index_module_types.html">Index of module types</a></span></h3><h1>Client API</h1><h2><a href="/eliom/6.2/api/client/Eliom_lib.html" class="ocsimore_phrasing_link">Eliom_lib</a></h2><h2><a href="/eliom/6.2/api/client/Eliom_client.html" class="ocsimore_phrasing_link">Eliom_client</a></h2><h2><a href="/eliom/6.2/api/client/Eliom_client_value.html" class="ocsimore_phrasing_link">Eliom_client_value</a></h2><h2>Content and form creation</h2><h3><a href="/eliom/6.2/api/client/Eliom_content.Html.html" class="ocsimore_phrasing_link">Eliom_content.Html</a></h3><h3><a href="/eliom/6.2/api/client/Eliom_content.Svg.html" class="ocsimore_phrasing_link">Eliom_content.Svg</a></h3><h3><a href="/eliom/6.2/api/client/Eliom_content.Xml.html" class="ocsimore_phrasing_link">Eliom_content.Xml</a></h3><h2>Client/server communication</h2><h3><a href="/eliom/6.2/api/client/Eliom_service.html" class="ocsimore_phrasing_link">Eliom_service</a></h3><h3><a href="/eliom/6.2/api/client/Eliom_shared.html" class="ocsimore_phrasing_link">Eliom_shared</a></h3><h3><a href="/eliom/6.2/api/client/Eliom_cscache.html" class="ocsimore_phrasing_link">Eliom_cscache</a></h3><h3><a href="/eliom/6.2/api/client/Eliom_bus.html" class="ocsimore_phrasing_link">Eliom_bus</a></h3><h3><a href="/eliom/6.2/api/client/Eliom_comet.html" class="ocsimore_phrasing_link">Eliom_comet</a></h3><h3><a href="/eliom/6.2/api/client/Eliom_react.html" class="ocsimore_phrasing_link">Eliom_react</a></h3><h2>Index</h2><h3> <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/client/index_types.html">Index of types</a></span></h3><h3> <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/client/index_exceptions.html">Index of exceptions</a></span></h3><h3> <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/client/index_values.html">Index of values</a></span></h3><h3> <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/client/index_modules.html">Index of modules</a></span></h3><h3> <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/client/index_module_types.html">Index of module types</a></span></h3><h1>Ppx syntax</h1><h2><a href="/eliom/6.2/api/ppx/Ppx_eliom.html" class="ocsimore_phrasing_link">Ppx_eliom</a></h2><h1>Ocamlbuild plugin</h1><h2><a href="/eliom/6.2/api/ocamlbuild/Ocamlbuild_eliom.html" class="ocsimore_phrasing_link">Ocamlbuild_eliom</a></h2><h1 id="wrapping">Wrapping  <a class="backref" href="#wrapping">&#182;</a></h1><p>Reading this chapter is not mandatory for writing Eliom
applications. However, it is worth reading if you are planning to hack
on the Eliom codebase.
</p><p>&lt;&lt;outline depth=&quot;2&quot;| &lt;&lt;header| **Table of contents** &gt;&gt; &gt;&gt;
</p><h2> Basics </h2><p>The server side of Eliom can communicate to the client other kinds of
data than the raw XML contents of the pages. The wrapper mechanism is
used to allow the browser side to access to the contents of variables
declared on server side. For instance when we write
&lt;&lt;code language=&quot;ocaml&quot;| ignore [%client (Dom_html.window##alert(Js.string ~%text) : unit)] &gt;&gt;
the contents of the <span class="teletype">text</span> variable is sent along the page for the client code to access it.
</p><p>Server side, when
&lt;&lt;code language=&quot;ocaml&quot;| [%client (Dom_html.window##alert(Js.string ~%text) : unit)] &gt;&gt;
is executed, the variable <span class="teletype">text</span> is registered into a table and an id is associated to it.
This table will contain all the data references by variables annotated with <span class="teletype">~%</span> in a page, and
will be sent marshalled to the client. On client side the id will be used to retrieve <span class="teletype">text</span>.
</p><p>Since all data are sent in one table, if a variable is referenced
multiples times, it will be sent only once, and sharing will be preserved:
</p><p>&lt;&lt;code language=&quot;ocaml&quot;|let a = ref 0 in
let b = (1,a) in
ignore [%client
  ((~%a := 42;
    Dom_html.window##alert(snd ~%b |&gt; string_of_int |&gt; Js.string))
   : unit)
]
&gt;&gt;
</p><p>This code will display 42. After being sent, the client and server
side values are distinct: the server side version of <span class="teletype">a</span> won't be
modified by the client side affectation and conversely the client side
value won't change if <span class="teletype">a</span> is changed later on server side.
</p><h2> Special types </h2><h3> Custom wrappers </h3><p>Usually, client and server side values are represented the same way,
and it is sufficient to only copy their content ( marshalled ) to the
client. But certain types can't be transmitted this easily: for
instance, services.
</p><p>Those values must be transformed before marshalling: We need for this to use
custom wrappers. This wrapping mechanism is defined in
<span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/Eliom_wrap.html">Eliom_wrap</a></span>.
</p><p>Before sending, the values goes thought <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/Eliom_wrap.html#VALwrap">Eliom_wrap.​wrap</a></span>
which transform marked values. A value marked is a value which have as its last field
a value of type <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/Eliom_wrap.html#TYPEwrapper">Eliom_wrap.​wrapper</a></span>. For instance
&lt;&lt;code language=&quot;ocaml&quot;|type marked_tupple =
  int * ... * marked_tupple Eliom_wrap.wrapper
type marked_record =
  { f1 : int;
    ...
    fn : marked_record Eliom_wrap.wrapper }
&gt;&gt;
but not
&lt;&lt;code language=&quot;ocaml&quot;|type not_marked_tupple = int * ... * marked_tupple Eliom_wrap.wrapper * float
type not_marked_tupple = int * ... * (int * marked_tupple Eliom_wrap.wrapper)
type not_marked_tupple = int * ... * marked_tupple Eliom_wrap.wrapper list
type not_marked_record =
     { f1 : int;
          ...
       fn : marked_record Eliom_wrap.wrapper;
       fk : float; }&gt;&gt;
</p><p>A wrapper is created by the <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/Eliom_wrap.html#VALcreate_wrapper">Eliom_wrap.​create_wrapper</a></span>
function. It takes a function as parameter which will be called to
transform the value during the wrapping. There is also a special
wrapper <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/Eliom_wrap.html#VALempty_wrapper">Eliom_wrap.​empty_wrapper</a></span> which does nothing. It
is useful to stop calling the wrapper on a value: If there is still a
wrapper in a value after its transformation, it will be called another
time, potentially leading to an infinite loop.
</p><p>For instance
</p><p>&lt;&lt;code language=&quot;ocaml&quot;|type v = Fun of unit -&gt; int | Value of int
type wrapped_type = v * wrapped_type Eliom_wrap.wrapper
let wrapper =
  let wrap = function
    | Value i,wrapper -&gt; Value i, Eliom_wrap.empty_wrapper
    | Fun f,wrapper -&gt; Value (f ()), Eliom_wrap.empty_wrapper
  in Eliom_wrap.create_wrapper f
let v = ( Fun (fun () -&gt; 1), wrapper )
let (v', empty_wrapper) = Eliom_wrap.wrap v&gt;&gt;
</p><p>At that time <span class="teletype">v'</span> will be <span class="teletype">Value 1</span>. Notice that
<span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/Eliom_wrap.html#VALcreate_wrapper">Eliom_wrap.​create_wrapper</a></span> does not enforce the output
type of the wrapping function to be the same as the input type:
Eliom_wrap is to be use with much caution! Do not use it if you don't
understand how it works, it may lead to unpredictable segmentation faults
and corrupted memory.
</p><h2> Eliom types with predefined custom wrappers </h2><p>The Eliom types that are marked are:
</p><ul><li> <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/Eliom_service.html#TYPEt">Eliom_service.​t</a></span> transformed to <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/Eliom_service.html#TYPEt">Eliom_service.​t</a></span> (but the client side representation)
</li><li> <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/Eliom_comet.Channel.html#TYPEt">Eliom_comet.​Channel.​t</a></span> transformed to <span><a class="ocsforge_doclink_lwt" href="/lwt/3.1.0/api/Lwt_stream.html#TYPEt">Lwt_stream.​t</a></span>
</li><li> <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/Eliom_react.Up.html#TYPEt">Eliom_react.​Up.​t</a></span> transformed to <span class="teletype"> 'a -&gt; unit </span>
</li><li> <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/Eliom_react.Down.html#TYPEt">Eliom_react.​Down.​t</a></span> transformed to <span class="teletype"> 'a React.E.t </span>
</li><li> <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/Eliom_bus.html#TYPEt">Eliom_bus.​t</a></span> transformed to <span><a class="ocsforge_doclink_eliom" href="/eliom/6.2/api/server/Eliom_bus.html#TYPEt">Eliom_bus.​t</a></span>
</li></ul></body></html>
